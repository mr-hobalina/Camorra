<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camorra Character Sheet</title>
<style>
:root{
  --bg:#0b0b10; --bg2:#111217;
  --panel:rgba(255,255,255,.07); --panel2:rgba(0,0,0,.45);
  --line:#2b2f3a;
  --fg:#ffffff; --muted:#d7d9e2;
  --accent:#c0392b;
  --input:#3a4160; --inputLine:#9aa1ba;
}
html,body{
  margin:0;padding:0;
  background:radial-gradient(circle at top,#2a2d3d 0,var(--bg2) 55%,var(--bg) 100%);
  color:var(--fg); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(5,5,10,.92);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);padding:.7rem 1rem;
}
.tabs{display:flex;gap:.5rem;flex-wrap:wrap}
.tabbtn{
  cursor:pointer;border-radius:999px;padding:.45rem .85rem;border:1px solid #555968;
  background:rgba(18,18,26,.95);font-size:.8rem;text-transform:uppercase;letter-spacing:.07em;color:var(--fg);
}
.tabbtn.active{background:var(--accent);border-color:var(--accent)}
main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:.75rem}
.panel{
  background:linear-gradient(145deg,var(--panel),var(--panel2));
  border:1px solid var(--line);border-radius:10px;padding:1rem;
  box-shadow:0 10px 25px rgba(0,0,0,.6);
}
h1{margin:0 0 .35rem 0;font-size:1.1rem;letter-spacing:.03em;text-transform:uppercase}
h2{margin:.2rem 0 .4rem 0;font-size:1.02rem;text-transform:uppercase;letter-spacing:.08em}
.grid{display:grid;gap:.75rem}
.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:.15rem;text-transform:uppercase;letter-spacing:.05em}
input,select,textarea{
  width:100%;box-sizing:border-box;padding:.45rem .55rem;border:1px solid var(--inputLine);border-radius:6px;
  background:var(--input);color:var(--fg);font-size:.9rem;
}
textarea{min-height:100px;resize:vertical}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px rgba(192,57,43,.4)}
table{width:100%;border-collapse:collapse;font-size:.9rem}
th,td{border:1px solid var(--line);padding:.35rem .45rem;text-align:left}
th{background:rgba(255,255,255,.07);font-size:.8rem;text-transform:uppercase;letter-spacing:.05em}
.subtle{font-size:.75rem;color:var(--muted)}
.muted{color:var(--muted);font-size:.8rem}
.hr{height:1px;background:var(--line);margin:.6rem 0}
.right{text-align:right}
.tiny3{width:3.2rem}
.tiny-check{width:auto}
.checkboxline{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.btnrow{display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap;margin-top:.5rem}
button{
  cursor:pointer;border-radius:6px;border:1px solid #555968;background:rgba(18,18,26,.95);
  padding:.4rem .65rem;font-size:.8rem;text-transform:uppercase;letter-spacing:.07em;color:var(--fg);
}
button.primary{background:var(--accent);border-color:var(--accent)}
button:hover{border-color:var(--accent)}
.hidden{display:none !important}
.attr-row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:end}
.savebox input{width:3.2rem}
.skill-attr-select{width:4.9rem;font-size:.8rem}
.weapon-name{max-width:11rem}
.weapon-dmg{max-width:8.5rem}
.state-btn{min-width:2.4rem;padding:.25rem .35rem;border-radius:6px;border:1px solid #555968;background:rgba(10,10,18,.95)}
.state-btn span{font-size:1rem}
.smallnote{font-size:.75rem;color:var(--muted);margin-top:.35rem}

/* --- Mobile layout fixes for Attributes SAVE boxes --- */
@media (max-width: 640px){
  /* make the attributes grid roomier */
  .cols-3{grid-template-columns:repeat(2,minmax(0,1fr));}
  /* hide SAVE labels to prevent crowding */
  .savebox label{display:none;}
  /* tighten save input */
  .savebox input{width:2.4rem; padding:.35rem .25rem;}
  /* make the main attribute select a bit wider */
  .tiny3{width:4.4rem;}
  .attr-row{gap:.4rem;}
}
@media (max-width: 420px){
  .cols-3{grid-template-columns:1fr;}
}

</style>
</head>
<body>
<header>
  <div class="tabs">
    <button id="tabCharacterBtn" class="tabbtn active" type="button">Character</button>
    <button id="tabCompanionBtn" class="tabbtn" type="button">Companion</button>
  </div>
</header>

<main>
  <!-- CHARACTER TAB -->
  <div id="tabCharacter">

    <section class="panel grid">
      <h1>Camorra Character Sheet</h1>

      <div class="grid cols-3">
        <div><label for="name">Name</label><input id="name"></div>
        <div><label for="title">Title</label><input id="title"></div>
        <div><label for="pcClass">Class</label>
          <select id="pcClass">
            <option>Advisor</option><option>Assault</option><option>Assassin</option><option>DMG</option>
            <option>Enforcer</option><option>Gunslinger</option><option>Medic</option><option>Engineer</option>
            <option>Whisperstep</option>
          </select>
        </div>
      </div>

      <div class="grid cols-4">
        <div><label for="hp">HP</label><input id="hp" type="number" class="tiny3"></div>
        <div><label for="tempHp">Temp HP</label><input id="tempHp" type="number" class="tiny3"></div>
        <div><label for="ac">Grit</label><input id="ac" type="number" class="tiny3"></div>
        <div><label for="dodge">Dodge</label><input id="dodge" type="number" class="tiny3"></div>
      </div>

      <div class="grid cols-3">
        <div><label for="initiative">Initiative</label><input id="initiative" type="number" class="tiny3"></div>
        <div><label for="level">Level</label><select id="level" class="tiny3"></select></div>
        <div><label for="style">Style</label>
          <select id="style" class="tiny3"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
      </div>

      <div class="grid cols-3">
        <div><label for="background">Background</label><input id="background"></div>
        <div><label for="nationality">Nationality</label>
          <select id="nationality"><option>Sonuzian</option><option>Camorran</option><option>Silician</option><option>Roselander</option>
            <option>Smaragaid</option></select>
        </div>
        <div><label for="hitDice">Hit Dice</label><input id="hitDice" class="tiny3" placeholder="e.g., 1d10"></div>
      </div>

      <div class="grid cols-3">
        <div><label for="pb">Proficiency Bonus</label>
          <select id="pb" class="tiny3"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
        </div>
        <div class="checkboxline"><label for="awesomePoint">Awesome Point</label><input id="awesomePoint" type="checkbox" class="tiny-check"></div>
        <div><label for="saveDC">Save DC</label><input id="saveDC" type="number" class="tiny3"></div>
      </div>

      <div class="grid cols-3">
        <div><label for="mainAttr">Main Class Attribute</label>
          <select id="mainAttr"><option>Toughness</option><option>Strength</option><option>Reflexes</option><option>Perception</option><option>Intelligence</option><option>Charisma</option></select>
        </div>
        <div><label for="classPoints">Class Points <span class="subtle">(Speechcraft, Brawl Points etc)</span></label>
          <input id="classPoints" type="number" min="0" max="25" class="tiny3">
        </div>
        <div></div>
      </div>
    </section>

    <section class="panel grid">
      <h2>Attributes</h2>
      <div class="grid cols-3">
        <div class="attr-row">
          <div><label for="Toughness">Toughness</label>
            <select id="Toughness" class="tiny3">
              <option value="-1">-1</option><option value="0" selected>0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="saveToughness">Save</label><input id="saveToughness" class="tiny3" placeholder="+0"></div>
        </div>

        <div class="attr-row">
          <div><label for="Strength">Strength</label>
            <select id="Strength" class="tiny3">
              <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="saveStrength">Save</label><input id="saveStrength" class="tiny3" placeholder="+0"></div>
        </div>

        <div class="attr-row">
          <div><label for="Reflexes">Reflexes</label>
            <select id="Reflexes" class="tiny3">
              <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="saveReflexes">Save</label><input id="saveReflexes" class="tiny3" placeholder="+0"></div>
        </div>
      </div>

      <div class="grid cols-3">
        <div class="attr-row">
          <div><label for="Perception">Perception</label>
            <select id="Perception" class="tiny3">
              <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="savePerception">Save</label><input id="savePerception" class="tiny3" placeholder="+0"></div>
        </div>

        <div class="attr-row">
          <div><label for="Intelligence">Intelligence</label>
            <select id="Intelligence" class="tiny3">
              <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="saveIntelligence">Save</label><input id="saveIntelligence" class="tiny3" placeholder="+0"></div>
        </div>

        <div class="attr-row">
          <div><label for="Charisma">Charisma</label>
            <select id="Charisma" class="tiny3">
              <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select>
          </div>
          <div class="savebox"><label for="saveCharisma">Save</label><input id="saveCharisma" class="tiny3" placeholder="+0"></div>
        </div>
      </div>
    </section>

    <section class="panel grid">
      <h2>Skills</h2>
      <table>
        <thead><tr><th>Prof?</th><th>Skill</th><th>Score</th><th>Attribute</th></tr></thead>
        <tbody id="skillsBody"></tbody>
      </table>
      <div class="smallnote">Skill score = ability score + PB (if proficient) + your manual adjustment (persistent).</div>
    </section>

    <section class="panel grid">
      <h2>Weapons</h2>
      <table><thead><tr><th>Weapon</th><th>Hit</th><th>Damage</th></tr></thead><tbody id="weaponsBody"></tbody></table>
    </section>

    <section class="panel grid">
      <h2>Abilities / Feats</h2>
      <div id="abilitiesContainer"></div>
      <div class="btnrow">
        <button id="addAbility" class="primary" type="button">Add Ability/Feat</button>
        <button id="removeAbility" type="button">Remove Last</button>
      </div>
      <label for="abilityInfo">Ability / Feat Information</label>
      <textarea id="abilityInfo"></textarea>
    </section>

    <section class="panel grid">
      <h2>Traits</h2>
      <textarea id="traits"></textarea>

      <div class="hr"></div>

      <h2>Items</h2>
      <div class="subtle">Capacity = 10 + PB + Strength, capped at 25.</div>
      <div class="grid cols-4" id="itemsBody"></div>

      <div class="hr"></div>

      <h2>Special Items</h2>
      <table><thead><tr><th>Special Item</th><th>Attuned?</th></tr></thead><tbody id="specialItemsBody"></tbody></table>

      <div class="hr"></div>

      <h2>Cash</h2>
      <div class="subtle">10 Silver Coins = 1 Silver Note.</div>
      <div class="grid cols-2">
        <div><label for="silverCoins">Silver Coins</label><input id="silverCoins" type="number" class="tiny3"></div>
        <div><label for="silverNotes">Silver Notes</label><input id="silverNotes" type="number" class="tiny3"></div>
      </div>

      <div class="hr"></div>

      <h2>Outfits</h2>
      <div class="subtle">5 Style Points = 1 Token<br>9 Style Points = 2 Tokens<br>12 Style Points = 3 Tokens</div>
      <div id="outfitsContainer"></div>
      <div class="subtle" style="margin-top:.5rem;">Total equipped Style Points: <input id="outfitsTotal" type="number" class="tiny3" readonly></div>
      <div class="btnrow">
        <button id="addOutfit" class="primary" type="button">Add Outfit</button>
        <button id="removeOutfit" type="button">Remove Last Outfit</button>
      </div>
    </section>

    <section class="panel grid">
      <h2>Immunities &amp; Resistances</h2>
      <textarea id="immunitiesResistances"></textarea>
    </section>

    <section class="panel">
      <div class="checkboxline" style="margin-bottom:.35rem;">
        <span>Wounded Save:</span>
        <button id="wounded1" type="button" class="state-btn"><span>⬜</span></button>
        <button id="wounded2" type="button" class="state-btn"><span>⬜</span></button>
      </div>
      <div class="checkboxline">
        <span>Death’s Door:</span>
        <button id="deaths1" type="button" class="state-btn"><span>⬜</span></button>
        <button id="deaths2" type="button" class="state-btn"><span>⬜</span></button>
      </div>
    </section>
  </div>

  <!-- COMPANION TAB -->
  <div id="tabCompanion" class="hidden">
    <section class="panel grid">
      <h1>Companion</h1>

      <div class="grid cols-3">
        <div><label for="compName">Name</label><input id="compName"></div>
        <div><label for="compType">Type</label>
          <select id="compType"><option>S.T.E.V.E</option><option>Soldier</option><option>Associate</option></select>
        </div>
        <div><label for="compPB">Proficiency Bonus</label><input id="compPB" class="tiny3" readonly></div>
      </div>

      <div class="grid cols-4">
        <div><label for="compHP">HP</label><input id="compHP" type="number" class="tiny3"></div>
        <div><label for="compAC">Grit</label><input id="compAC" type="number" class="tiny3"></div>
        <div><label for="compMove">Movement</label><input id="compMove" class="tiny3" placeholder="30"></div>
        <div><label for="compInitiative">Initiative</label><input id="compInitiative" type="number" class="tiny3"></div>
      </div>

      <div class="grid cols-3">
        <div><label for="compSaveDC">Save DC</label><input id="compSaveDC" type="number" class="tiny3"></div>
        <div><label for="compMainAttr">Main Stat</label>
          <select id="compMainAttr"><option>Toughness</option><option>Strength</option><option>Reflexes</option><option>Perception</option><option>Intelligence</option><option>Charisma</option></select>
        </div>
        <div class="subtle" style="align-self:end;">Auto + manual adjustment (like main sheet)</div>
      </div>
    </section>

    <section class="panel grid">
      <h2>Ability Scores</h2>
      <div class="grid cols-3">
        <div><label for="compToughness">Toughness</label>
          <select id="compToughness" class="tiny3">
            <option value="-1">-1</option><option value="0" selected>0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div><label for="compStrength">Strength</label>
          <select id="compStrength" class="tiny3">
            <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div><label for="compReflexes">Reflexes</label>
          <select id="compReflexes" class="tiny3">
            <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
      </div>

      <div class="grid cols-3">
        <div><label for="compPerception">Perception</label>
          <select id="compPerception" class="tiny3">
            <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div><label for="compIntelligence">Intelligence</label>
          <select id="compIntelligence" class="tiny3">
            <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
        <div><label for="compCharisma">Charisma</label>
          <select id="compCharisma" class="tiny3">
            <option value="-1" selected>-1</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
          </select>
        </div>
      </div>
    </section>

    <section class="panel grid">
      <h2>Skills</h2>
      <div class="subtle">Skills use appropriate ability score.</div>
      <div class="subtle">Companion uses the same Proficiency Bonus as the player.</div>
    </section>

    <section class="panel grid">
      <h2>Abilities</h2>
      <div id="compAbilitiesContainer"></div>
      <div class="btnrow">
        <button id="addCompAbility" class="primary" type="button">Add Ability</button>
        <button id="removeCompAbility" type="button">Remove Last</button>
      </div>
      <label for="compAbilityInfo">Ability Information</label>
      <textarea id="compAbilityInfo"></textarea>
    </section>

    <section class="panel grid">
      <h2>Weapons</h2>
      <table><thead><tr><th>Weapon</th><th>Hit</th><th>Damage</th></tr></thead><tbody id="compWeaponsBody"></tbody></table>
    </section>

    <section class="panel grid">
      <h2>Immunities &amp; Resistances</h2>
      <textarea id="compImmunitiesResistances"></textarea>
    </section>
  </div>

  <section class="panel right">
    <button id="exportBtn" type="button">Export JSON</button>
    <button id="importBtn" type="button">Import JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <span class="muted">Data is saved locally in your browser.</span>
  </section>
</main>

<script>
const SKILLS = [
  {"key":"Endurance","label":"Endurance","dual":false,"attr":"Toughness"},
  {"key":"Athletics","label":"Athletics","dual":false,"attr":"Strength"},
  {"key":"BreachingBreaking","label":"Breaching/Breaking","dual":false,"attr":"Strength"},
  {"key":"Intimidation","label":"Intimidation","dual":true,"attrs":["Strength","Charisma"]},
  {"key":"Acrobatics","label":"Acrobatics","dual":false,"attr":"Reflexes"},
  {"key":"SleightofHand","label":"Sleight of Hand","dual":false,"attr":"Reflexes"},
  {"key":"Stealth","label":"Stealth","dual":false,"attr":"Reflexes"},
  {"key":"Driving","label":"Driving","dual":false,"attr":"Reflexes"},
  {"key":"Demolition","label":"Demolition","dual":false,"attr":"Perception"},
  {"key":"Insight","label":"Insight","dual":false,"attr":"Perception"},
  {"key":"Investigation","label":"Investigation","dual":false,"attr":"Perception"},
  {"key":"Mechanics","label":"Mechanics","dual":false,"attr":"Perception"},
  {"key":"Bootlegging","label":"Bootlegging","dual":false,"attr":"Perception"},
  {"key":"WeaponKnowledge","label":"Weapon Knowledge","dual":true,"attrs":["Perception","Intelligence"]},
  {"key":"Business","label":"Business","dual":false,"attr":"Intelligence"},
  {"key":"Medicine","label":"Medicine","dual":false,"attr":"Intelligence"},
  {"key":"History","label":"History","dual":false,"attr":"Intelligence"},
  {"key":"Law","label":"Law","dual":false,"attr":"Intelligence"},
  {"key":"Technology","label":"Technology","dual":false,"attr":"Intelligence"},
  {"key":"Forgery","label":"Forgery","dual":false,"attr":"Intelligence"},
  {"key":"Herbalism","label":"Herbalism","dual":false,"attr":"Intelligence"},
  {"key":"Performance","label":"Performance","dual":false,"attr":"Charisma"},
  {"key":"Charm","label":"Charm","dual":false,"attr":"Charisma"},
  {"key":"Lying","label":"Lying","dual":false,"attr":"Charisma"}
];
</script>
<script>
(() => {
  const STORAGE_KEY = "camorra_sheet_latest_complete";
  const TAB_KEY = "camorra_tab_latest_complete";
  const $ = (id) => document.getElementById(id);

  // Tabs
  function setTab(which){
    const isChar = which === "character";
    $("tabCharacter").classList.toggle("hidden", !isChar);
    $("tabCompanion").classList.toggle("hidden", isChar);
    $("tabCharacterBtn").classList.toggle("active", isChar);
    $("tabCompanionBtn").classList.toggle("active", !isChar);
    localStorage.setItem(TAB_KEY, which);
  }
  $("tabCharacterBtn").addEventListener("click", () => setTab("character"));
  $("tabCompanionBtn").addEventListener("click", () => setTab("companion"));
  setTab(localStorage.getItem(TAB_KEY) || "character");

  // Levels 1-25
  const lvl = $("level");
  for(let i=1;i<=25;i++){
    const o=document.createElement("option");
    o.value=String(i); o.textContent=String(i);
    lvl.appendChild(o);
  }
  if(!lvl.value) lvl.value="1";

  function clamp(n, lo, hi, fallback=0){
    n = Number(n);
    if(!Number.isFinite(n)) return fallback;
    return Math.max(lo, Math.min(hi, n));
  }
  function pb(){ return clamp($("pb").value, 1, 6, 1); }

  function attrScore(name){
    const el = $(name);
    return clamp(el?.value, -1, 10, -1);
  }

  // --- Save DC auto + manual delta ---
  let saveDcDelta = 0;
  function computeSaveDcBase(){ return 10 + pb() + attrScore($("mainAttr").value); }
  function updateSaveDC(){
    const base = computeSaveDcBase();
    $("saveDC").value = base + saveDcDelta;
  }
  $("saveDC").addEventListener("input", () => {
    const base = computeSaveDcBase();
    const desired = Number($("saveDC").value);
    if(Number.isFinite(desired)) saveDcDelta = desired - base;
    save();
  });

  // 3-state buttons
  const STATES = ["blank","tick","cross"];
  const SYMBOL = { blank:"⬜", tick:"✔", cross:"✖" };
  function setState(btn, st){
    btn.dataset.state = st;
    btn.querySelector("span").textContent = SYMBOL[st] || SYMBOL.blank;
  }
  function cycle(btn){
    const cur = btn.dataset.state || "blank";
    const nxt = STATES[(STATES.indexOf(cur)+1)%STATES.length];
    setState(btn, nxt);
    save();
  }
  ["wounded1","wounded2","deaths1","deaths2"].forEach(id => {
    const b=$(id);
    b.addEventListener("click", ()=>cycle(b));
    if(!b.dataset.state) setState(b,"blank"); else setState(b,b.dataset.state);
  });

  // --- Skills: auto + manual persistent adjustment ---
  const skillBonus = {};
  function computeSkillBase(skill){
    const prof = document.querySelector(`input[data-skill-prof="${skill.key}"]`)?.checked;
    let a = skill.attr;
    if(skill.dual){
      a = document.querySelector(`select[data-skill-attr="${skill.key}"]`)?.value || skill.attrs[0];
    }
    const score = attrScore(a);
    return score + (prof ? pb() : 0);
  }

  function buildSkills(){
    const body = $("skillsBody");
    body.innerHTML = "";
    for(const skill of SKILLS){
      const tr=document.createElement("tr");

      const tdProf=document.createElement("td");
      const cb=document.createElement("input");
      cb.type="checkbox"; cb.className="tiny-check";
      cb.dataset.skillProf = skill.key;
      tdProf.appendChild(cb);

      const tdName=document.createElement("td");
      tdName.textContent=skill.label;

      const tdScore=document.createElement("td");
      const inp=document.createElement("input");
      inp.type="number"; inp.className="tiny3";
      inp.dataset.skillScore = skill.key;
      tdScore.appendChild(inp);

      const tdAttr=document.createElement("td");
      if(skill.dual){
        const sel=document.createElement("select");
        sel.className="skill-attr-select";
        sel.dataset.skillAttr = skill.key;
        for(const a of skill.attrs){
          const o=document.createElement("option");
          o.value=a; o.textContent=a;
          sel.appendChild(o);
        }
        tdAttr.appendChild(sel);
      } else {
        const span=document.createElement("span");
        span.className="muted"; span.textContent=skill.attr;
        tdAttr.appendChild(span);
      }

      tr.appendChild(tdProf); tr.appendChild(tdName); tr.appendChild(tdScore); tr.appendChild(tdAttr);
      body.appendChild(tr);
    }

    body.querySelectorAll("input[data-skill-score]").forEach(el => {
      el.addEventListener("input", () => {
        const key = el.dataset.skillScore;
        const skill = SKILLS.find(s=>s.key===key);
        const base = computeSkillBase(skill);
        const desired = el.value==="" ? base : Number(el.value);
        if(!Number.isFinite(desired)) return;
        skillBonus[key] = desired - base;
        save();
      });
    });

    body.querySelectorAll("input[data-skill-prof], select[data-skill-attr]").forEach(el => {
      el.addEventListener("change", () => { updateDerived(); save(); });
    });
  }

  function updateSkillScores(){
    for(const skill of SKILLS){
      const base = computeSkillBase(skill);
      const bonus = Number(skillBonus[skill.key] ?? 0);
      const el = document.querySelector(`input[data-skill-score="${skill.key}"]`);
      if(el) el.value = base + bonus;
    }
  }

  // Weapons: 5 rows
  function buildWeapons(tbodyId, prefix){
    const body = $(tbodyId); body.innerHTML = "";
    for(let i=0;i<5;i++){
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><input class="weapon-name" data-w="${prefix}name-${i}" placeholder="Weapon name"></td>
        <td><input class="tiny3" data-w="${prefix}hit-${i}" placeholder="+X"></td>
        <td><input class="weapon-dmg" data-w="${prefix}dmg-${i}" placeholder="e.g., 2d12+10"></td>
      `;
      body.appendChild(tr);
    }
  }
  buildWeapons("weaponsBody","pc_");
  buildWeapons("compWeaponsBody","co_");

  // Special Items: 5 rows w/ attune checkbox
  function buildSpecialItems(){
    const body = $("specialItemsBody"); body.innerHTML="";
    for(let i=0;i<5;i++){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td><input data-si="name-${i}" placeholder="Special item"></td>
                      <td class="right"><input type="checkbox" data-si="attune-${i}" class="tiny-check"></td>`;
      body.appendChild(tr);
    }
  }
  buildSpecialItems();

  // Items: capacity scales
  function capacity(){ return Math.min(25, 10 + pb() + attrScore("Strength")); }
  function buildItems(){
    const body = $("itemsBody"); body.innerHTML="";
    for(let i=1;i<=25;i++){
      const wrap=document.createElement("div");
      wrap.innerHTML = `<label>Item ${i}</label><input data-item="${i}">`;
      body.appendChild(wrap);
    }
  }
  buildItems();

  function updateItemsVisibility(){
    const cap = capacity();
    document.querySelectorAll("[data-item]").forEach(inp => {
      const idx = Number(inp.dataset.item);
      inp.parentElement.style.display = idx <= cap ? "" : "none";
    });
  }

  // Abilities/Feats dynamic
  function addAbilityRow(containerId, prefix){
    const c = $(containerId);
    const idx = c.children.length;
    const row=document.createElement("div");
    row.className="grid cols-3";
    row.style.marginBottom = ".5rem";
    row.innerHTML = `
      <div><label>${prefix} Name</label><input data-ab="${prefix}name-${idx}"></div>
      <div><label>${prefix} Uses</label><input data-ab="${prefix}uses-${idx}" class="tiny3"></div>
      <div></div>
    `;
    c.appendChild(row);
  }
  function removeAbilityRow(containerId){
    const c = $(containerId);
    if(c.lastElementChild) c.removeChild(c.lastElementChild);
  }
  $("addAbility").addEventListener("click", () => { addAbilityRow("abilitiesContainer","Ability/Feat"); save(); });
  $("removeAbility").addEventListener("click", () => { removeAbilityRow("abilitiesContainer"); save(); });
  $("addCompAbility").addEventListener("click", () => { addAbilityRow("compAbilitiesContainer","Ability"); save(); });
  $("removeCompAbility").addEventListener("click", () => { removeAbilityRow("compAbilitiesContainer"); save(); });

  for(let i=0;i<5;i++) addAbilityRow("abilitiesContainer","Ability/Feat");
  for(let i=0;i<4;i++) addAbilityRow("compAbilitiesContainer","Ability");

  // Outfits dynamic
  function addOutfit(){
    const c=$("outfitsContainer");
    const idx=c.children.length;
    const row=document.createElement("div");
    row.className="grid cols-3";
    row.style.marginBottom=".5rem";
    row.innerHTML = `
      <div><label>Outfit Name</label><input data-of="name-${idx}"></div>
      <div><label>Points</label><input data-of="points-${idx}" type="number" class="tiny3"></div>
      <div class="checkboxline"><label>Equipped</label><input data-of="eq-${idx}" type="checkbox" class="tiny-check"></div>
    `;
    c.appendChild(row);
  }
  function removeOutfit(){
    const c=$("outfitsContainer");
    if(c.lastElementChild) c.removeChild(c.lastElementChild);
  }
  $("addOutfit").addEventListener("click", () => { addOutfit(); save(); updateOutfitTotal(); });
  $("removeOutfit").addEventListener("click", () => { removeOutfit(); save(); updateOutfitTotal(); });

  for(let i=0;i<6;i++) addOutfit();

  function updateOutfitTotal(){
    let total=0;
    document.querySelectorAll('[data-of^="eq-"]').forEach(eq => {
      const idx = eq.dataset.of.split("-")[1];
      const pts = Number(document.querySelector(`[data-of="points-${idx}"]`)?.value || 0);
      if(eq.checked) total += pts;
    });
    $("outfitsTotal").value = total;
  }

  // Companion PB mirrors player PB
  function updateCompPB(){ $("compPB").value = String(pb()); }

  // Companion Save DC: auto + manual delta
  let compSaveDcDelta = 0;
  function compAttrScore(name){
    const el = $(name);
    return clamp(el?.value, -1, 10, -1);
  }
  function computeCompSaveDcBase(){
    return 10 + pb() + compAttrScore("comp"+$("compMainAttr").value);
  }
  function updateCompSaveDC(){
    const base = computeCompSaveDcBase();
    $("compSaveDC").value = base + compSaveDcDelta;
  }
  $("compSaveDC").addEventListener("input", () => {
    const base = computeCompSaveDcBase();
    const desired = Number($("compSaveDC").value);
    if(Number.isFinite(desired)) compSaveDcDelta = desired - base;
    save();
  });

  function updateDerived(){
    updateCompPB();
    updateItemsVisibility();
    updateSkillScores();
    updateSaveDC();
    updateCompSaveDC();
    updateOutfitTotal();
  }

  ["pb","mainAttr","Strength","Toughness","Reflexes","Perception","Intelligence","Charisma"].forEach(id => {
    const el=$(id);
    el && el.addEventListener("change", () => { updateDerived(); save(); });
  });
  ["compMainAttr","compToughness","compStrength","compReflexes","compPerception","compIntelligence","compCharisma"].forEach(id => {
    const el=$(id);
    el && el.addEventListener("change", () => { updateDerived(); save(); });
  });

  document.addEventListener("input", (e) => {
    const t = e.target;
    if(!t) return;
    if(t.matches("input,select,textarea")){
      if(t.dataset.of) updateOutfitTotal();
      save();
    }
  });

  // Save/Load
  function getAllValues(){
    const data = {};
    document.querySelectorAll("input,select,textarea,button.state-btn").forEach(el => {
      if(!el.id) return;
      if(el.classList.contains("state-btn")) data[el.id] = el.dataset.state || "blank";
      else if(el.type==="checkbox") data[el.id] = el.checked;
      else data[el.id] = el.value;
    });

    data._w = {};
    document.querySelectorAll("[data-w]").forEach(el => data._w[el.dataset.w] = el.value);

    data._si = {};
    document.querySelectorAll("[data-si]").forEach(el => {
      data._si[el.dataset.si] = (el.type==="checkbox") ? el.checked : el.value;
    });

    data._items = {};
    document.querySelectorAll("[data-item]").forEach(el => data._items[el.dataset.item] = el.value);

    data._ab = {};
    document.querySelectorAll("[data-ab]").forEach(el => data._ab[el.dataset.ab] = el.value);

    data._of = {};
    document.querySelectorAll("[data-of]").forEach(el => {
      data._of[el.dataset.of] = (el.type==="checkbox") ? el.checked : el.value;
    });

    data._skillProf = {};
    document.querySelectorAll("[data-skill-prof]").forEach(el => data._skillProf[el.dataset.skillProf] = el.checked);

    data._skillAttr = {};
    document.querySelectorAll("[data-skill-attr]").forEach(el => data._skillAttr[el.dataset.skillAttr] = el.value);

    data._skillBonus = skillBonus;
    data._saveDcDelta = saveDcDelta;
    data._compSaveDcDelta = compSaveDcDelta;
    return data;
  }

  function applyAllValues(data){
    if(!data) return;

    for(const [k,v] of Object.entries(data)){
      if(k.startsWith("_")) continue;
      const el = $(k);
      if(!el) continue;
      if(el.classList.contains("state-btn")) setState(el, v || "blank");
      else if(el.type==="checkbox") el.checked = !!v;
      else el.value = v;
    }

    if(data._w) for(const [k,v] of Object.entries(data._w)){
      const el=document.querySelector(`[data-w="${k}"]`); if(el) el.value=v;
    }
    if(data._si) for(const [k,v] of Object.entries(data._si)){
      const el=document.querySelector(`[data-si="${k}"]`);
      if(el) (el.type==="checkbox" ? el.checked=!!v : el.value=v);
    }
    if(data._items) for(const [k,v] of Object.entries(data._items)){
      const el=document.querySelector(`[data-item="${k}"]`); if(el) el.value=v;
    }
    if(data._ab) for(const [k,v] of Object.entries(data._ab)){
      const el=document.querySelector(`[data-ab="${k}"]`); if(el) el.value=v;
    }
    if(data._of) for(const [k,v] of Object.entries(data._of)){
      const el=document.querySelector(`[data-of="${k}"]`);
      if(el) (el.type==="checkbox" ? el.checked=!!v : el.value=v);
    }
    if(data._skillProf) for(const [k,v] of Object.entries(data._skillProf)){
      const el=document.querySelector(`input[data-skill-prof="${k}"]`); if(el) el.checked=!!v;
    }
    if(data._skillAttr) for(const [k,v] of Object.entries(data._skillAttr)){
      const el=document.querySelector(`select[data-skill-attr="${k}"]`); if(el) el.value=v;
    }
    if(data._skillBonus) for(const [k,v] of Object.entries(data._skillBonus)) skillBonus[k]=v;

    saveDcDelta = Number(data._saveDcDelta || 0);
    compSaveDcDelta = Number(data._compSaveDcDelta || 0);
  }

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(getAllValues())); }
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{ applyAllValues(JSON.parse(raw)); } catch(e){}
  }

  // Export / Import JSON
  $("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(getAllValues(), null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "camorra_character.json";
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try { applyAllValues(JSON.parse(reader.result)); updateDerived(); save(); }
      catch(err){ alert("Import failed: invalid JSON"); }
    };
    reader.readAsText(file);
  });

  // Init
  buildSkills();
  load();
  updateDerived();
})();
</script>
</body>
</html>
